"""
ToxiGuard API ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
Version 1.0 - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æ¯’æ€§æ¤œçŸ¥
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from datetime import datetime
import os
from dotenv import load_dotenv
from app.routers import analyze
import logging

# ãƒ­ã‚°è¨­å®šï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œè¨˜éŒ²ï¼‰
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’èª­ã‚€ï¼‰
load_dotenv()

# FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
app = FastAPI(
    title="ToxiGuard API",
    description="æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®æ¯’æ€§ã‚’æ¤œçŸ¥ã™ã‚‹API - Release 1",
    version="1.0.0",
    docs_url="/docs",      # Swagger UIã®URL
    redoc_url="/redoc"     # ReDocã®URL
)

# CORSè¨­å®šï¼ˆä»–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ï¼‰
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],       # ã™ã¹ã¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨±å¯ï¼ˆæœ¬ç•ªã§ã¯åˆ¶é™ã™ã‚‹ï¼‰
    allow_credentials=True,
    allow_methods=["*"],       # ã™ã¹ã¦ã®HTTPãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨±å¯
    allow_headers=["*"],       # ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯
)

# ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ ï¼ˆ/api/v1/analyzeãªã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ï¼‰
app.include_router(analyze.router)

@app.get("/")
async def root():
    """
    APIã®ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    ãƒ–ãƒ©ã‚¦ã‚¶ã§http://localhost:8000/ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹
    """
    return {
        "message": "Welcome to ToxiGuard API ğŸ›¡ï¸",
        "version": "1.0.0",
        "release": "Release 1 - Keyword Based",
        "endpoints": {
            "/": "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            "/docs": "APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆSwagger UIï¼‰",
            "/api/v1/analyze": "ãƒ†ã‚­ã‚¹ãƒˆæ¯’æ€§åˆ†æ",
            "/api/v1/analyze/health": "åˆ†æã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹"
        },
        "accuracy": "40%",
        "method": "Keyword matching",
        "timestamp": datetime.now().isoformat()
    }

@app.get("/health")
async def health_check():
    """
    ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    ç›£è¦–ãƒ„ãƒ¼ãƒ«ãªã©ã‹ã‚‰å®šæœŸçš„ã«å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®š
    """
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "components": {
            "api": "healthy",
            "analyzer": "healthy"
        }
    }

# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
if __name__ == "__main__":
    import uvicorn
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’èª­ã‚€ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "8000"))
    
    # èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    print(f"""
    ğŸš€ ToxiGuard API Release 1 Starting...
    ğŸ“ URL: http://localhost:{port}
    ğŸ“š Docs: http://localhost:{port}/docs
    ğŸ¯ Accuracy: 40% (Keyword-based)
    """)
    
    # ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
    uvicorn.run(app, host=host, port=port, reload=True)
